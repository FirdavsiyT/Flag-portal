{% for challenge in challenges_data %}
<div class="glass-panel p-5 rounded-xl border border-[#2c2f3b] flex flex-col relative group transition-all duration-300 hover:-translate-y-1 hover:border-[#9fef00]/50 challenge-card filter-item"
     data-category="{{ challenge.category }}"
     data-points="{{ challenge.points }}">

    <!-- Status Indicators -->
    <div class="absolute top-4 right-4 flex gap-2">
        {% if challenge.solved %}
            <span class="px-2 py-0.5 rounded bg-[#9fef00]/10 border border-[#9fef00]/20 text-[#9fef00] text-[10px] font-bold uppercase tracking-wider flex items-center gap-1 shadow-[0_0_10px_rgba(159,239,0,0.2)]">
                <i data-lucide="check" class="w-3 h-3"></i> Solved
            </span>
        {% elif challenge.failed %}
            <span class="px-2 py-0.5 rounded bg-red-500/10 border border-red-500/20 text-red-500 text-[10px] font-bold uppercase tracking-wider flex items-center gap-1">
                <i data-lucide="x-circle" class="w-3 h-3"></i> Failed
            </span>
        {% endif %}
    </div>

    <!-- Header -->
    <div class="mb-4">
        <span class="text-[#5a6278] text-[10px] font-mono uppercase tracking-widest border border-[#2c2f3b] px-2 py-1 rounded mb-2 inline-block">
            {{ challenge.category }}
        </span>
        <h3 class="text-xl font-bold text-white group-hover:text-[#9fef00] transition-colors line-clamp-1" title="{{ challenge.title }}">
            {{ challenge.title }}
        </h3>
        <p class="text-[#9fef00] font-mono text-sm font-bold">{{ challenge.points }} PTS</p>
    </div>

    <!-- Description Preview -->
    <div class="flex-grow">
         <!-- Tags / Difficulty -->
        <div class="flex items-center gap-2 mb-4">
             <span class="text-[10px] px-2 py-0.5 rounded font-mono uppercase font-bold
                {% if challenge.difficulty == 'Easy' %}bg-green-500/10 text-green-500
                {% elif challenge.difficulty == 'Medium' %}bg-yellow-500/10 text-yellow-500
                {% else %}bg-red-500/10 text-red-500{% endif %}">
                {{ challenge.difficulty }}
            </span>
        </div>
    </div>

    <!-- Footer Stats & Solves -->
    <div class="mt-4 pt-4 border-t border-[#2c2f3b]">
        <div class="flex justify-between items-center mb-3">
             <div class="text-[#5a6278] text-xs font-mono flex items-center gap-1">
                <i data-lucide="users" class="w-3 h-3"></i> {{ challenge.solves|length }} solves
             </div>
             <div class="text-[#5a6278] text-xs font-mono">
                {% if challenge.max_attempts > 0 %}
                    {{ challenge.attempts }} / {{ challenge.max_attempts }} tries
                {% else %}
                    ∞ tries
                {% endif %}
             </div>
        </div>

        <!-- Latest Solvers Avatars (Real-time updated) -->
        <div class="flex -space-x-2 overflow-hidden py-1 h-8">
            {% for solver in challenge.solves %}
                <img class="inline-block h-6 w-6 rounded-full ring-2 ring-[#0d0e12] bg-[#1a1c23]"
                     src="{{ solver.avatar }}"
                     alt="{{ solver.user }}"
                     title="{{ solver.user }} solved at {{ solver.date }}">
            {% empty %}
                <span class="text-[10px] text-[#5a6278] italic self-center">No solves yet</span>
            {% endfor %}
        </div>

        <!-- Action Button -->
        <button onclick="openModal('{{ challenge.id }}', '{{ challenge.title|escapejs }}', '{{ challenge.desc|escapejs }}')"
           class="w-full mt-4 bg-[#1a1c23] hover:bg-[#9fef00] hover:text-black border border-[#2c2f3b] hover:border-[#9fef00] text-white text-xs font-bold uppercase py-2 rounded transition-all flex items-center justify-center gap-2 group/btn">
           {% if challenge.solved %}
                <i data-lucide="eye" class="w-3 h-3"></i> View Flag
           {% elif challenge.failed %}
                <i data-lucide="lock" class="w-3 h-3"></i> Locked
           {% else %}
                <i data-lucide="flag" class="w-3 h-3"></i> Solve Challenge
           {% endif %}
        </button>
    </div>
</div>
{% empty %}
<div class="col-span-full text-center py-12">
    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-[#1a1c23] mb-4">
        <i data-lucide="folder-open" class="text-[#5a6278]"></i>
    </div>
    <p class="text-[#5a6278]">No challenges found in the database.</p>
</div>
{% endfor %}

<script>
    // Переинициализация иконок после обновления HTMX с проверкой
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
    // Восстановление фильтров (если были применены)
    if (typeof applyCurrentFilters === 'function') {
        applyCurrentFilters();
    }
</script>