<!-- Chart Script Update -->
<div id="graph-data-container">
    {{ graph_data|json_script:"graph-data" }}
</div>

<script>
    // Функция для перерисовки графика
    (function updateChart() {
        const graphDataElement = document.getElementById('graph-data');
        if (!graphDataElement) return;

        try {
            const newData = JSON.parse(graphDataElement.textContent);
            // Если график уже существует (глобальная переменная window.myChart, которую нужно создать в основном шаблоне), обновляем его
            if (window.myChart) {
                window.myChart.data = newData;
                window.myChart.update();
            } else {
                // Если нет, создаем (на случай первого рендера через htmx)
                const ctx = document.getElementById('scoreChart').getContext('2d');
                window.myChart = new Chart(ctx, {
                    type: 'line',
                    data: newData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { type: 'linear', grid: { color: 'rgba(255, 255, 255, 0.05)' } },
                            y: { grid: { color: 'rgba(255, 255, 255, 0.05)' } }
                        }
                    }
                });
            }
        } catch (e) { console.error(e); }
    })();
</script>

<!-- Table Body -->
<table class="w-full text-left border-collapse">
    <thead>
        <tr class="text-[#5a6278] uppercase text-[10px] font-bold tracking-widest border-b border-[#2c2f3b]">
            <th class="p-4 w-16 text-center font-mono">UID</th>
            <th class="p-4 font-mono">USER</th>
            <th class="p-4 text-center font-mono">FLAGS</th>
            <th class="p-4 text-right font-mono">SCORE</th>
        </tr>
    </thead>
    <tbody class="divide-y divide-[#2c2f3b]/50">
        {% for player in leaderboard_data %}
        <tr class="group transition-colors hover:bg-[#9fef00]/5 {% if player.isMe %}bg-[#9fef00]/10 border-l-2 border-l-[#9fef00]{% endif %} fade-in">
            <td class="p-4 text-center font-mono text-[#5a6278] group-hover:text-white transition-colors">
                {% if player.rank == 1 %}<span class="text-yellow-400">#1</span>
                {% elif player.rank == 2 %}<span class="text-gray-400">#2</span>
                {% elif player.rank == 3 %}<span class="text-amber-700">#3</span>
                {% else %}<span class="opacity-50">#{{ player.rank }}</span>{% endif %}
            </td>
            <td class="p-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-[#1a1c23] border border-[#2c2f3b] overflow-hidden">
                        <img src="{{ player.avatar }}" class="w-full h-full object-cover">
                    </div>
                    <span class="font-bold text-sm text-white font-mono">{{ player.user }}</span>
                    {% if player.isMe %}
                        <span class="text-[9px] bg-[#9fef00]/20 text-[#9fef00] px-1.5 py-0.5 rounded border border-[#9fef00]/20 font-mono uppercase">YOU</span>
                    {% endif %}
                </div>
            </td>
            <td class="p-4 text-center">
                <span class="font-mono text-xs text-[#9ca3af] bg-[#1a1c23] px-2 py-1 rounded border border-[#2c2f3b]">{{ player.solved }}</span>
            </td>
            <td class="p-4 text-right">
                <span class="font-bold text-white font-mono tracking-tight text-lg group-hover:text-[#9fef00] transition-colors">{{ player.points }}</span>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>