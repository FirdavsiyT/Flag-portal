{% extends 'base.html' %}

{% block header_title %}scoreboard{% endblock %}

{% block content %}
<section class="max-w-5xl mx-auto fade-in"
         hx-get="{% url 'scoreboard' %}"
         hx-trigger="data_refresh from:body"
         hx-target="#scoreboard-container"
         hx-swap="innerHTML">

    <!-- График активности -->
    <h2 class="text-xl font-bold text-white mb-5 flex items-center gap-3">
        <div class="w-1 h-6 bg-[#9fef00] shadow-[0_0_10px_rgba(159,239,0,0.5)]"></div>
        Score Metrics
    </h2>
    <div class="glass-panel rounded-xl overflow-hidden border border-[#2c2f3b] mb-12">
        <div class="p-4 border-b border-[#2c2f3b] bg-[#15171e] flex items-center gap-3">
            <span class="text-xs text-[#5a6278] font-mono ml-2">./score_progression.sh --live</span>
            <span class="text-[10px] text-[#9fef00] font-mono border border-[#9fef00]/20 bg-[#9fef00]/10 px-2 py-0.5 rounded tracking-wider animate-pulse">LIVE</span>
        </div>
        <div class="p-6 bg-[#0d0e12]/50">
            <div class="relative h-[300px] w-full">
                <canvas id="scoreChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Таблица лидеров (REAL TIME) -->
    <h2 class="text-xl font-bold text-white mb-5 flex items-center gap-3">
        <div class="w-1 h-6 bg-[#9fef00] shadow-[0_0_10px_rgba(159,239,0,0.5)]"></div>
        Top Hackers
    </h2>
    <div class="glass-panel rounded-xl overflow-hidden border border-[#2c2f3b] shadow-2xl">
        <div class="p-4 border-b border-[#2c2f3b] bg-[#15171e] flex items-center gap-3">
            <span class="text-xs text-[#5a6278] font-mono ml-2">cat /etc/leaderboard</span>
        </div>

        <!-- Контейнер для обновления -->
        <div id="scoreboard-container" class="overflow-x-auto bg-[#0d0e12]/30">
            {% include 'partials/scoreboard_data.html' %}
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Инициализация графика (глобальная переменная для доступа из partials)
    window.myChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        const ctxElement = document.getElementById('scoreChart');
        const graphDataElement = document.getElementById('graph-data');

        if (ctxElement && graphDataElement) {
            const ctx = ctxElement.getContext('2d');
            try {
                const initialData = JSON.parse(graphDataElement.textContent);

                window.myChart = new Chart(ctx, {
                    type: 'line',
                    data: initialData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { type: 'linear', grid: { color: 'rgba(255, 255, 255, 0.05)' } },
                            y: { grid: { color: 'rgba(255, 255, 255, 0.05)' } }
                        },
                        elements: { line: { borderWidth: 2, tension: 0 }, point: { radius: 0, hoverRadius: 6 } }
                    }
                });
            } catch (e) {
                console.error("Error parsing graph data:", e);
            }
        } else {
            console.warn("Graph elements not found. Chart initialization skipped.");
        }
    });
</script>
{% endblock %}